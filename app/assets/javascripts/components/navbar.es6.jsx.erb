class Navbar extends React.Component {
  constructor(props, context) {
    super(props, context);

    this.state = { showSpinner: false };
  }

  render() {
    return (
      <div className="row">
        <div className="col-md-4">
          <div className="navbar-header">
            <a className="navbar-brand">
              <div className="navbar-spinner">
                <svg
                  className={this.getSpinnerCssClass()}
                  viewBox="0 0 66 66"
                  xmlns="http://www.w3.org/2000/svg">
                  <circle
                    className="path"
                    fill="none"
                    strokeWidth="6"
                    strokeLinecap="round"
                    cx="33"
                    cy="33"
                    r="30"></circle>
                </svg>

                <img
                  src="<%= asset_path 'logo-donkeywhite.png' %>"
                  className={this.getLogoCssClass()} />
              </div>

              <span className="navbar-brand-title">Mykonote</span>
            </a>
            <button
              className="navbar-toggle navbar-hamburger-button"
              type="button"
              onClick={this.handleHamburgerButtonClick}>
              <span className="icon-bar"></span>
              <span className="icon-bar"></span>
              <span className="icon-bar"></span>
            </button>
            <button
              className="navbar-toggle navbar-search-button" type="button"
              onClick={this.handleSearchButtonClick.bind(this)}
              ref={this.setupSearchButtonRef.bind(this)}>
              <i className="material-icons">search</i>
            </button>
          </div>
          <div
            className="navbar-form navbar-right search-bar collapse in-sm"
            ref={this.setupSearchBoxRef.bind(this)}>
            <div className="form-group">
              <input
                type="text"
                className="string optional form-control"
                placeholder="Search"
                onChange={this.props.handleSearchEnter}
                ref={(c) => this.$searchInput = $(c)} />
            </div>
          </div>
        </div>
      </div>
    );
  }

  componentDidMount() {
    // listen on global event so we can toggle the spinner from unrelated
    // components
    $(document).on('mykonote.spinner', (e, data) => {
      this.setState({ showSpinner: data });
    });
  }

  componentWillUnmount() {
    $(document).off('mykonote.spinner');
  }

  getSpinnerCssClass() {
    let cssClass = 'spinner';
    if (!this.state.showSpinner) {
      cssClass += ' hidden';
    }

    return cssClass;
  }

  getLogoCssClass() {
    let cssClass = 'navbar-logo';
    if (this.state.showSpinner) {
      cssClass += ' hidden';
    }

    return cssClass;
  }

  handleSearchButtonClick(e) {
    if (!ViewportMode.isMobileMode()) {
      return;
    }

    const $button = $(e.target);
    if ($button.hasClass('is-expanded')) {
      $button.removeClass('is-expanded');
      EventHive.publish('search.hide');
    }
    else {
      $button.addClass('is-expanded');
      EventHive.publish('search.show');
    }
  }

  handleHamburgerButtonClick(e) {
    if (!ViewportMode.isMobileMode()) {
      return;
    }

    const $hamburger = $(e.target);
    if ($hamburger.hasClass('is-expanded')) {
      $hamburger.removeClass('is-expanded');
      EventHive.publish('hamburger.hide');
    }
    else {
      $hamburger.addClass('is-expanded');
      EventHive.publish('hamburger.show');
    }
  }

  setupSearchButtonRef(c) {
    if (!ViewportMode.isMobileMode()) {
      return;
    }

    const $searchButton = $(c);

    EventHive.subscribe('search.hide', function() {
      $searchButton.removeClass('is-expanded');
    });
  }

  setupSearchBoxRef(c) {
    if (!ViewportMode.isMobileMode()) {
      return;
    }

    const $searchBox = $(c);
    $searchBox.collapse({ toggle: false });

    EventHive.subscribe('search.show', function() {
      $searchBox.collapse('show');
    });
    EventHive.subscribe('search.hide', function() {
      $searchBox.collapse('hide');
    });

    EventHive.subscribe('note.open', () => {
      if (this.$searchInput.val() === '') {
        EventHive.publish('search.hide');
      }
    });

    $searchBox.off('shown.bs.collapse').on('shown.bs.collapse', () => {
      this.$searchInput.focus();
    });
  }
}
